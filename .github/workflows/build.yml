name: Build Multi-Platform

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake
    
    - name: Build
      run: |
        mkdir -p build
        cd build
        cmake ..
        make -j$(nproc)
    
    - name: Test binary
      run: |
        ./build/iDSK20 help || true
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: iDSK20-linux-x64
        path: build/iDSK20

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
    
    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu cmake
    
    - name: Build for ARM64
      run: |
        mkdir -p build-arm64
        cd build-arm64
        cmake .. \
          -DCMAKE_SYSTEM_NAME=Linux \
          -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
          -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
          -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
        make -j$(nproc)
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: iDSK20-linux-arm64
        path: build-arm64/iDSK20

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        brew install cmake
    
    - name: Build
      run: |
        mkdir -p build
        cd build
        cmake ..
        make -j$(sysctl -n hw.ncpu)
    
    - name: Test binary
      run: |
        ./build/iDSK20 help || true
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: iDSK20-macos-x64
        path: build/iDSK20

  build-macos-arm64:
    name: Build macOS ARM64 (Apple Silicon)
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        brew install cmake
    
    - name: Build
      run: |
        mkdir -p build
        cd build
        cmake ..
        make -j$(sysctl -n hw.ncpu)
    
    - name: Test binary
      run: |
        ./build/iDSK20 help || true
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: iDSK20-macos-arm64
        path: build/iDSK20

  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Build
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64
        cmake --build . --config Release
    
    - name: Test binary
      run: |
        .\build\Release\iDSK20.exe help
      continue-on-error: true
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: iDSK20-windows-x64
        path: build/Release/iDSK20.exe

  create-release:
    name: Create Release Package
    needs: [build-linux, build-linux-arm64, build-macos, build-macos-arm64, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display structure
      run: ls -R artifacts
    
    - name: Create release archive
      run: |
        mkdir -p release
        cd artifacts
        for dir in */; do
          cd "$dir"
          if [ -f iDSK20 ] || [ -f iDSK20.exe ]; then
            zip -r "../../release/${dir%/}.zip" *
          fi
          cd ..
        done
    
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iDSK20-all-platforms
        path: release/*.zip
