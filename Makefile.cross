# Makefile para cross-compilation de disc
# Uso: make -f Makefile.cross <target>

.PHONY: all clean clean-temp native windows linux-arm64 macos-arm64 help install-deps

# Variables
VERSION := 1.0.0
BUILD_DIR := dist
BINARY_NAME := disc

# Target por defecto
all: help

# Ayuda
help:
	@echo "ğŸš€ Makefile de Cross-Compilation para disc"
	@echo ""
	@echo "Targets disponibles:"
	@echo "  native        - Compilar para plataforma actual"
	@echo "  windows       - Cross-compilar para Windows (requiere MinGW)"
	@echo "  linux-arm64   - Cross-compilar para Linux ARM64 (requiere toolchain)"
	@echo "  macos-x64     - Cross-compilar para macOS x64 (desde macOS ARM64)"
	@echo "  all-local     - Compilar todas las plataformas disponibles localmente"
	@echo "  all-docker    - Compilar todas las plataformas con Docker"
	@echo "  clean         - Limpiar builds"
	@echo "  clean-temp    - Limpiar solo builds temporales (mantener dist/)"
	@echo "  install-deps  - Instalar dependencias de cross-compilation"
	@echo "  package       - Crear paquetes de distribuciÃ³n"
	@echo ""
	@echo "Ejemplos:"
	@echo "  make -f Makefile.cross native"
	@echo "  make -f Makefile.cross windows"
	@echo "  make -f Makefile.cross all-local"

# Limpiar builds
clean:
	@echo "ğŸ§¹ Limpiando builds..."
	@rm -rf build build-windows build-linux build-macos build-native $(BUILD_DIR) cmake CMakeCache.txt cmake_install.cmake Makefile CMakeFiles/
	@rm -rf build-linux-x64 build-linux-arm64 build-macos-x64 build-macos-arm64
	@echo "âœ… Limpieza completada"

# Limpiar solo builds temporales (mantener dist/)
clean-temp:
	@echo "ğŸ§¹ Limpiando builds temporales..."
	@rm -rf build-windows build-linux build-macos build-native cmake CMakeCache.txt cmake_install.cmake Makefile CMakeFiles/
	@rm -rf build-linux-x64 build-linux-arm64 build-macos-x64 build-macos-arm64
	@echo "âœ… Builds temporales limpiados (mantenido: dist/ y build/)"

# CompilaciÃ³n nativa
native: clean
	@echo "ğŸ”§ Compilando para plataforma nativa..."
	@./build.sh
	@mkdir -p $(BUILD_DIR)
	@case "$$(uname -s)" in \
		Darwin) \
			if [ "$$(uname -m)" = "arm64" ]; then \
				mkdir -p $(BUILD_DIR)/macos-arm64 && cp build/$(BINARY_NAME) $(BUILD_DIR)/macos-arm64/; \
				echo "âœ… macOS ARM64 compilado"; \
			else \
				mkdir -p $(BUILD_DIR)/macos-x64 && cp build/$(BINARY_NAME) $(BUILD_DIR)/macos-x64/; \
				echo "âœ… macOS x64 compilado"; \
			fi ;; \
		Linux) \
			if [ "$$(uname -m)" = "aarch64" ]; then \
				mkdir -p $(BUILD_DIR)/linux-arm64 && cp build/$(BINARY_NAME) $(BUILD_DIR)/linux-arm64/; \
				echo "âœ… Linux ARM64 compilado"; \
			else \
				mkdir -p $(BUILD_DIR)/linux-x64 && cp build/$(BINARY_NAME) $(BUILD_DIR)/linux-x64/; \
				echo "âœ… Linux x64 compilado"; \
			fi ;; \
	esac

# Cross-compilation para Windows
windows:
	@echo "ğŸ”§ Cross-compilando para Windows..."
	@if ! command -v x86_64-w64-mingw32-gcc >/dev/null 2>&1; then \
		echo "âŒ MinGW no encontrado. Instala con:"; \
		echo "   macOS: brew install mingw-w64"; \
		echo "   Ubuntu: sudo apt install mingw-w64"; \
		exit 1; \
	fi
	@mkdir -p cmake $(BUILD_DIR)/windows-x64
	@echo 'set(CMAKE_SYSTEM_NAME Windows)' > cmake/mingw-toolchain.cmake
	@echo 'set(CMAKE_C_COMPILER x86_64-w64-mingw32-gcc)' >> cmake/mingw-toolchain.cmake
	@echo 'set(CMAKE_CXX_COMPILER x86_64-w64-mingw32-g++)' >> cmake/mingw-toolchain.cmake
	@echo 'set(CMAKE_RC_COMPILER x86_64-w64-mingw32-windres)' >> cmake/mingw-toolchain.cmake
	@echo 'set(CMAKE_FIND_ROOT_PATH /usr/x86_64-w64-mingw32)' >> cmake/mingw-toolchain.cmake
	@echo 'set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)' >> cmake/mingw-toolchain.cmake
	@echo 'set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)' >> cmake/mingw-toolchain.cmake
	@echo 'set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)' >> cmake/mingw-toolchain.cmake
	@mkdir -p build-windows && cd build-windows && \
		cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/mingw-toolchain.cmake .. && \
		make -j$$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
	@if [ -f build-windows/$(BINARY_NAME).exe ]; then \
		cp build-windows/$(BINARY_NAME).exe $(BUILD_DIR)/windows-x64/; \
		echo "âœ… Windows x64 compilado"; \
	else \
		echo "âŒ Error compilando Windows"; \
		exit 1; \
	fi

# Cross-compilation para macOS x64 (desde macOS ARM64)
macos-x64:
	@echo "ğŸ”§ Cross-compilando para macOS x64..."
	@if [ "$(uname -s)" != "Darwin" ] || [ "$(uname -m)" != "arm64" ]; then \
		echo "âŒ Este target solo funciona en macOS ARM64"; \
		exit 1; \
	fi
	@mkdir -p cmake $(BUILD_DIR)/macos-x64
	@echo '# Toolchain para cross-compilation de macOS ARM64 a macOS x64' > cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_SYSTEM_NAME Darwin)' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_SYSTEM_PROCESSOR x86_64)' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_C_COMPILER clang)' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_CXX_COMPILER clang++)' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_C_FLAGS_INIT "-target x86_64-apple-macos10.15")' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_CXX_FLAGS_INIT "-target x86_64-apple-macos10.15")' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_EXE_LINKER_FLAGS_INIT "-target x86_64-apple-macos10.15")' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_OSX_ARCHITECTURES x86_64)' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_OSX_DEPLOYMENT_TARGET 10.15)' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)' >> cmake/macos-x64-toolchain.cmake
	@echo 'set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)' >> cmake/macos-x64-toolchain.cmake
	@mkdir -p build-macos-x64 && cd build-macos-x64 && \
		cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/macos-x64-toolchain.cmake .. && \
		make -j$(sysctl -n hw.ncpu 2>/dev/null || echo 4)
	@if [ -f build-macos-x64/$(BINARY_NAME) ]; then \
		cp build-macos-x64/$(BINARY_NAME) $(BUILD_DIR)/macos-x64/; \
		echo "âœ… macOS x64 compilado"; \
	else \
		echo "âŒ Error compilando macOS x64"; \
		exit 1; \
	fi
	@echo "ğŸ”§ Cross-compilando para Linux ARM64..."
	@if ! command -v aarch64-linux-gnu-gcc >/dev/null 2>&1; then \
		echo "âŒ Toolchain ARM64 no encontrado. Instala con:"; \
		echo "   Ubuntu: sudo apt install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu"; \
		echo "   macOS: brew install aarch64-elf-gcc"; \
		exit 1; \
	fi
	@mkdir -p cmake $(BUILD_DIR)/linux-arm64
	@echo 'set(CMAKE_SYSTEM_NAME Linux)' > cmake/arm64-toolchain.cmake
	@echo 'set(CMAKE_SYSTEM_PROCESSOR aarch64)' >> cmake/arm64-toolchain.cmake
	@echo 'set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)' >> cmake/arm64-toolchain.cmake
	@echo 'set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)' >> cmake/arm64-toolchain.cmake
	@mkdir -p build-linux-arm64 && cd build-linux-arm64 && \
		cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/arm64-toolchain.cmake .. && \
		make -j$$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
	@if [ -f build-linux-arm64/$(BINARY_NAME) ]; then \
		cp build-linux-arm64/$(BINARY_NAME) $(BUILD_DIR)/linux-arm64/; \
		echo "âœ… Linux ARM64 compilado"; \
	else \
		echo "âŒ Error compilando Linux ARM64"; \
		exit 1; \
	fi

# Compilar todas las plataformas disponibles localmente
all-local:
	@echo "ğŸš€ Compilando todas las plataformas disponibles..."
	@./build-local-cross.sh

# Compilar todas las plataformas con Docker
all-docker:
	@echo "ğŸš€ Compilando todas las plataformas con Docker..."
	@./build-multiplatform.sh

# Crear paquetes
package:
	@echo "ğŸ“¦ Creando paquetes de distribuciÃ³n..."
	@if [ ! -d "$(BUILD_DIR)" ]; then \
		echo "âŒ No hay binarios para empaquetar. Ejecuta 'make all-local' primero."; \
		exit 1; \
	fi
	@cd $(BUILD_DIR) && \
	for dir in */; do \
		if [ -d "$$dir" ]; then \
			platform=$${dir%/}; \
			temp_dir="$(BINARY_NAME)-$(VERSION)-$$platform"; \
			mkdir -p "$$temp_dir"; \
			if [ -f "$$dir/$(BINARY_NAME)" ]; then \
				cp "$$dir/$(BINARY_NAME)" "$$temp_dir/"; \
			elif [ -f "$$dir/$(BINARY_NAME).exe" ]; then \
				cp "$$dir/$(BINARY_NAME).exe" "$$temp_dir/"; \
			fi; \
			cp ../README.md "$$temp_dir/" 2>/dev/null || true; \
			cp ../AUTHORS "$$temp_dir/" 2>/dev/null || true; \
			cp ../COPYING "$$temp_dir/" 2>/dev/null || true; \
			if command -v zip >/dev/null 2>&1; then \
				zip -r "$(BINARY_NAME)-$(VERSION)-$$platform.zip" "$$temp_dir"; \
				echo "âœ… Paquete ZIP: $(BINARY_NAME)-$(VERSION)-$$platform.zip"; \
			fi; \
			if [ "$$platform" != "windows-x64" ]; then \
				tar -czf "$(BINARY_NAME)-$(VERSION)-$$platform.tar.gz" "$$temp_dir"; \
				echo "âœ… Tarball: $(BINARY_NAME)-$(VERSION)-$$platform.tar.gz"; \
			fi; \
			rm -rf "$$temp_dir"; \
		fi; \
	done

# Instalar dependencias de cross-compilation
install-deps:
	@echo "ğŸ“¥ Instalando dependencias de cross-compilation..."
	@case "$$(uname -s)" in \
		Darwin) \
			echo "ğŸº Instalando con Homebrew..."; \
			brew install mingw-w64 || echo "âš ï¸  Error instalando mingw-w64"; \
			;; \
		Linux) \
			if command -v apt >/dev/null 2>&1; then \
				echo "ğŸ“¦ Instalando con apt..."; \
				sudo apt update; \
				sudo apt install -y mingw-w64 gcc-aarch64-linux-gnu g++-aarch64-linux-gnu; \
			elif command -v yum >/dev/null 2>&1; then \
				echo "ğŸ“¦ Instalando con yum..."; \
				sudo yum install -y mingw64-gcc mingw64-gcc-c++; \
			else \
				echo "âŒ Gestor de paquetes no soportado"; \
			fi; \
			;; \
		*) \
			echo "âŒ Plataforma no soportada para instalaciÃ³n automÃ¡tica"; \
			;; \
	esac
	@echo "âœ… InstalaciÃ³n de dependencias completada"